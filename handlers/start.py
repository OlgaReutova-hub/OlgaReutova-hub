import logging
from aiogram import Router, F
from aiogram.filters import CommandStart, Command
from aiogram.types import Message
from aiogram.fsm.context import FSMContext

from keyboards import get_main_keyboard
from states import UserStates

router = Router()
logger = logging.getLogger(__name__)


@router.message(CommandStart())
async def cmd_start(message: Message, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start"""
    logger.info(f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {message.from_user.id} (@{message.from_user.username}) –æ—Ç–ø—Ä–∞–≤–∏–ª /start")
    
    await state.set_state(UserStates.main_menu)
    logger.debug(f"  FSM —Å–æ—Å—Ç–æ—è–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ: main_menu")
    
    welcome_text = (
        "üëã –ü—Ä–∏–≤–µ—Ç! –Ø –±–æ—Ç-–ø–æ–º–æ—â–Ω–∏–∫ –ø–æ –∫—É–ª–∏–Ω–∞—Ä–∏–∏ –∏ –ø–∏—Ç–∞–Ω–∏—é!\n\n"
        "–ß—Ç–æ —è —É–º–µ—é:\n"
        "üç≥ <b>–ù–∞–π—Ç–∏ —Ä–µ—Ü–µ–ø—Ç</b> - –ø—Ä–µ–¥–ª–æ–∂—É —Ä–µ—Ü–µ–ø—Ç—ã –ø–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É\n"
        "üìä <b>–ü–æ–¥—Å—á–∏—Ç–∞—Ç—å –∫–∞–ª–æ—Ä–∏–∏</b> - –ø–æ—Å—á–∏—Ç–∞—é –∫–∞–ª–æ—Ä–∏–∏ –∏ –ë–ñ–£ –≤ –≤–∞—à–∏—Ö –±–ª—é–¥–∞—Ö\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–µ –Ω–∏–∂–µ üëá"
    )
    
    try:
        keyboard = get_main_keyboard()
        logger.debug(f"–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å–æ–∑–¥–∞–Ω–∞: {keyboard}")
        logger.debug(f"–¢–∏–ø –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã: {type(keyboard)}")
        
        # –ü—Ä–æ—Å—Ç–æ–π —Ç–µ–∫—Å—Ç –±–µ–∑ HTML
        simple_text = (
            "–ü—Ä–∏–≤–µ—Ç! –Ø –±–æ—Ç-–ø–æ–º–æ—â–Ω–∏–∫ –ø–æ –∫—É–ª–∏–Ω–∞—Ä–∏–∏ –∏ –ø–∏—Ç–∞–Ω–∏—é!\n\n"
            "–ß—Ç–æ —è —É–º–µ—é:\n"
            "- –ù–∞–π—Ç–∏ —Ä–µ—Ü–µ–ø—Ç - –ø—Ä–µ–¥–ª–æ–∂—É —Ä–µ—Ü–µ–ø—Ç—ã –ø–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É\n"
            "- –ü–æ–¥—Å—á–∏—Ç–∞—Ç—å –∫–∞–ª–æ—Ä–∏–∏ - –ø–æ—Å—á–∏—Ç–∞—é –∫–∞–ª–æ—Ä–∏–∏ –∏ –ë–ñ–£ –≤ –≤–∞—à–∏—Ö –±–ª—é–¥–∞—Ö\n\n"
            "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–µ –Ω–∏–∂–µ"
        )
        
        result = await message.answer(
            simple_text,
            reply_markup=keyboard
        )
        logger.info(f"‚úÖ –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {message.from_user.id}")
        logger.debug(f"–†–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏: {result}")
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è: {e}", exc_info=True)


@router.message(Command("help"))
@router.message(F.text == "‚ÑπÔ∏è –ü–æ–º–æ—â—å")
async def cmd_help(message: Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /help"""
    logger.info(f"‚ÑπÔ∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {message.from_user.id} –∑–∞–ø—Ä–æ—Å–∏–ª –ø–æ–º–æ—â—å")
    
    help_text = (
        "üìñ <b>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é:</b>\n\n"
        
        "üç≥ <b>–ü–æ–∏—Å–∫ —Ä–µ—Ü–µ–ø—Ç–æ–≤:</b>\n"
        "   ‚Ä¢ –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É '–ù–∞–π—Ç–∏ —Ä–µ—Ü–µ–ø—Ç'\n"
        "   ‚Ä¢ –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞ –∏–ª–∏ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã\n"
        "   ‚Ä¢ –ü–æ–ª—É—á–∏—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–µ—Ü–µ–ø—Ç–æ–≤ –Ω–∞ –≤—ã–±–æ—Ä\n\n"
        
        "üìä <b>–ü–æ–¥—Å—á–µ—Ç –∫–∞–ª–æ—Ä–∏–π:</b>\n"
        "   ‚Ä¢ –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É '–ü–æ–¥—Å—á–∏—Ç–∞—Ç—å –∫–∞–ª–æ—Ä–∏–∏'\n"
        "   ‚Ä¢ –í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –≤–≤–æ–¥–∞:\n"
        "     - –¢–µ–∫—Å—Ç–æ–º: –æ–ø–∏—à–∏—Ç–µ –±–ª—é–¥–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä: '200–≥ –∫—É—Ä–∏—Ü–∞, 100–≥ —Ä–∏—Å')\n"
        "     - –§–æ—Ç–æ: –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é –≤–∞—à–µ–≥–æ –±–ª—é–¥–∞\n"
        "   ‚Ä¢ –ü–æ–ª—É—á–∏—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–∞–ª–æ—Ä–∏—è—Ö –∏ –ë–ñ–£\n\n"
        
        "üí° <b>–°–æ–≤–µ—Ç—ã:</b>\n"
        "   ‚Ä¢ –î–ª—è —Ç–æ—á–Ω–æ–≥–æ –ø–æ–¥—Å—á–µ—Ç–∞ –∫–∞–ª–æ—Ä–∏–π —É–∫–∞–∑—ã–≤–∞–π—Ç–µ –≤–µ—Å –ø—Ä–æ–¥—É–∫—Ç–æ–≤\n"
        "   ‚Ä¢ –ú–æ–∂–Ω–æ –≤–≤–æ–¥–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç—ã –Ω–∞ —Ä—É—Å—Å–∫–æ–º –∏–ª–∏ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º\n"
        "   ‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É '‚óÄÔ∏è –ù–∞–∑–∞–¥' –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –º–µ–Ω—é\n\n"
        
        "‚ùì –ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–ª–∏ –≤–æ–ø—Ä–æ—Å—ã - –ø–∏—à–∏—Ç–µ /start –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã"
    )
    
    await message.answer(help_text, parse_mode="HTML")


@router.message(F.text == "‚óÄÔ∏è –ù–∞–∑–∞–¥")
async def back_to_menu(message: Message, state: FSMContext):
    """–í–æ–∑–≤—Ä–∞—Ç –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"""
    logger.info(f"‚¨ÖÔ∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {message.from_user.id} –Ω–∞–∂–∞–ª '–ù–∞–∑–∞–¥'")
    await state.set_state(UserStates.main_menu)
    
    await message.answer(
        "–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é üè†",
        reply_markup=get_main_keyboard()
    )

