# ๐๏ธ ะััะธัะตะบัััะฐ ะขะตะปะตะณัะฐะผ ะะพัะฐ

## ๐ ะะฑะทะพั

ะะพั ะฟะพัััะพะตะฝ ะฝะฐ ัะพะฒัะตะผะตะฝะฝะพะน ะผะพะดัะปัะฝะพะน ะฐััะธัะตะบัััะต ั ะธัะฟะพะปัะทะพะฒะฐะฝะธะตะผ aiogram 3.x ะธ ะฐัะธะฝััะพะฝะฝะพะณะพ ะฟัะพะณัะฐะผะผะธัะพะฒะฐะฝะธั.

## ๐ฏ ะัะฝะพะฒะฝัะต ะบะพะผะฟะพะฝะตะฝัั

### 1. **Main.py** - ะขะพัะบะฐ ะฒัะพะดะฐ
```
main.py
โโโ ะะฝะธัะธะฐะปะธะทะฐัะธั Bot ะธ Dispatcher
โโโ ะะพะดะบะปััะตะฝะธะต ัะพััะตัะพะฒ
โโโ ะะฐะฟััะบ polling
โโโ ะะฑัะฐะฑะพัะบะฐ ะพัะธะฑะพะบ
```

**ะคัะฝะบัะธะธ:**
- ะกะพะทะดะฐะฝะธะต ัะบะทะตะผะฟะปััะฐ ะฑะพัะฐ
- ะะฐัััะพะนะบะฐ FSM ััะฐะฝะธะปะธัะฐ (MemoryStorage)
- ะะตะณะธัััะฐัะธั ะฒัะตั ะพะฑัะฐะฑะพััะธะบะพะฒ
- ะะฐะฟััะบ ะฟัะพัะตััะฐ polling

---

### 2. **Config** - ะะพะฝัะธะณััะฐัะธั

```
config/
โโโ settings.py    # ะะฐะณััะทะบะฐ ะฝะฐัััะพะตะบ ะธะท .env
โโโ __init__.py    # ะญะบัะฟะพัั ะฝะฐัััะพะตะบ
.env               # ะะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั (ะฝะต ะฒ git)
.env.example       # ะจะฐะฑะปะพะฝ ะดะปั .env
```

**ะกะพะดะตัะถะธั:**
- ะขะพะบะตะฝ Telegram ะฑะพัะฐ (ะธะท .env)
- API ะบะปััะธ ะดะปั ะฒะฝะตัะฝะธั ัะตัะฒะธัะพะฒ (ะธะท .env)
- URL ัะฝะดะฟะพะธะฝัะพะฒ
- ะะฐัััะพะนะบะธ ะบััะธัะพะฒะฐะฝะธั

**ะะตะทะพะฟะฐัะฝะพััั:**
- ะัะต ััะฒััะฒะธัะตะปัะฝัะต ะดะฐะฝะฝัะต ะฒ `.env`
- `.env` ะดะพะฑะฐะฒะปะตะฝ ะฒ `.gitignore`
- `.env.example` - ัะฐะฑะปะพะฝ ะฑะตะท ัะตะฐะปัะฝัั ะบะปััะตะน

---

### 3. **Handlers** - ะะฑัะฐะฑะพััะธะบะธ ัะพะฑััะธะน

```
handlers/
โโโ start.py       # /start, /help, ะฝะฐะฒะธะณะฐัะธั
โโโ recipes.py     # ะะพะธัะบ ัะตัะตะฟัะพะฒ
โโโ calories.py    # ะะพะดััะตั ะบะฐะปะพัะธะน
```

#### 3.1 Start Handler
**ะัะฒะตัััะฒะตะฝะฝะพััั:**
- ะัะธะฒะตัััะฒะธะต ะฟะพะปัะทะพะฒะฐัะตะปั (`/start`)
- ะกะฟัะฐะฒะบะฐ (`/help`)
- ะะพะทะฒัะฐั ะฒ ะณะปะฐะฒะฝะพะต ะผะตะฝั
- ะฃะฟัะฐะฒะปะตะฝะธะต FSM ัะพััะพัะฝะธัะผะธ

**ะะพะผะฐะฝะดั:**
- `/start` - ะะฐะฟััะบ ะฑะพัะฐ
- `/help` - ะกะฟัะฐะฒะบะฐ ะฟะพ ะธัะฟะพะปัะทะพะฒะฐะฝะธั
- `โ๏ธ ะะฐะทะฐะด` - ะะพะทะฒัะฐั ะฒ ะผะตะฝั

#### 3.2 Recipes Handler
**ะัะฒะตัััะฒะตะฝะฝะพััั:**
- ะัะธะตะผ ะทะฐะฟัะพัะฐ ะฝะฐ ะฟะพะธัะบ ัะตัะตะฟัะฐ
- ะะฐะปะธะดะฐัะธั ะฒะฒะพะดะฐ ะฟะพะปัะทะพะฒะฐัะตะปั
- ะัะทะพะฒ Recipe Service
- ะคะพัะผะฐัะธัะพะฒะฐะฝะธะต ะธ ะพัะฟัะฐะฒะบะฐ ัะตะทัะปััะฐัะพะฒ

**Flow:**
1. ะะพะปัะทะพะฒะฐัะตะปั ะฝะฐะถะธะผะฐะตั "๐ณ ะะฐะนัะธ ัะตัะตะฟั"
2. FSM ะฟะตัะตัะพะดะธั ะฒ ัะพััะพัะฝะธะต `waiting_for_recipe_query`
3. ะะพะปัะทะพะฒะฐัะตะปั ะฒะฒะพะดะธั ะทะฐะฟัะพั
4. ะัะฟัะฐะฒะบะฐ ะทะฐะฟัะพัะฐ ะฒ Recipe API
5. ะะพะปััะตะฝะธะต ะธ ัะพัะผะฐัะธัะพะฒะฐะฝะธะต ัะตัะตะฟัะพะฒ
6. ะัะฟัะฐะฒะบะฐ ะฟะพะปัะทะพะฒะฐัะตะปั

#### 3.3 Calories Handler
**ะัะฒะตัััะฒะตะฝะฝะพััั:**
- ะัะธะตะผ ะฑะปัะดะฐ ัะตะบััะพะผ ะธะปะธ ัะพัะพ
- ะะฑัะฐะฑะพัะบะฐ ะธะทะพะฑัะฐะถะตะฝะธะน
- ะะพะดััะตั ะบะฐะปะพัะธะน ัะตัะตะท API
- ะคะพัะผะฐัะธัะพะฒะฐะฝะธะต ัะตะทัะปััะฐัะพะฒ

**Flow:**
1. ะัะฑะพั ัะฟะพัะพะฑะฐ ะฒะฒะพะดะฐ (ัะตะบัั/ัะพัะพ)
2. ะะฑัะฐะฑะพัะบะฐ ะฒะฒะพะดะฐ
3. ะัะทะพะฒ Calorie Service
4. ะะฐััะตั ะะะฃ
5. ะัะฟัะฐะฒะบะฐ ัะตะทัะปััะฐัะฐ

---

### 4. **Services** - ะะธะทะฝะตั-ะปะพะณะธะบะฐ

```
services/
โโโ recipe_api.py      # ะะฐะฑะพัะฐ ั API ัะตัะตะฟัะพะฒ
โโโ calorie_api.py     # API ะฟะพะดััะตัะฐ ะบะฐะปะพัะธะน
โโโ image_analyzer.py  # ะะฝะฐะปะธะท ัะพัะพ
```

#### 4.1 Recipe Service
```python
class RecipeService:
    async def search_recipes(query: str) -> List[Dict]
    async def get_recipe_by_ingredients(ingredients: List[str]) -> List[Dict]
```

**ะคัะฝะบัะธะธ:**
- ะะพะธัะบ ัะตัะตะฟัะพะฒ ะฟะพ ัะตะบััะพะฒะพะผั ะทะฐะฟัะพัั
- ะคะธะปัััะฐัะธั ะฟะพ ะธะฝะณัะตะดะธะตะฝัะฐะผ
- ะะฑัะฐะฑะพัะบะฐ API ะพัะฒะตัะพะฒ
- ะััะธัะพะฒะฐะฝะธะต ัะตะทัะปััะฐัะพะฒ

#### 4.2 Calorie Service
```python
class CalorieService:
    async def get_nutrition_info(food_query: str) -> List[Dict]
    async def analyze_meal(meal_description: str) -> Dict
```

**ะคัะฝะบัะธะธ:**
- ะะพะปััะตะฝะธะต ะดะฐะฝะฝัั ะพ ะบะฐะปะพัะธัั
- ะะฐััะตั ะะะฃ (ะฑะตะปะบะธ, ะถะธัั, ัะณะปะตะฒะพะดั)
- ะกัะผะผะธัะพะฒะฐะฝะธะต ะดะปั ัะพััะฐะฒะฝัั ะฑะปัะด
- ะะฐะปะธะดะฐัะธั ะดะฐะฝะฝัั

#### 4.3 Image Analyzer
```python
class ImageAnalyzer:
    async def analyze_food_image(image_path: str) -> Optional[str]
    async def download_and_save(file_path: str) -> Path
```

**ะคัะฝะบัะธะธ:**
- ะกะบะฐัะธะฒะฐะฝะธะต ัะพัะพ ะพั ะฟะพะปัะทะพะฒะฐัะตะปั
- ะกะพััะฐะฝะตะฝะธะต ะฒ ะบัั
- ะะฝะฐะปะธะท ะธะทะพะฑัะฐะถะตะฝะธั (ะทะฐะณะปััะบะฐ ะดะปั AI)
- ะัะธััะบะฐ ะฒัะตะผะตะฝะฝัั ัะฐะนะปะพะฒ

**ะัะธะผะตัะฐะฝะธะต:** ะะปั ะฟะพะปะฝะพัะตะฝะฝะพะน ัะฐะฑะพัั ััะตะฑัะตััั ะธะฝัะตะณัะฐัะธั ั:
- OpenAI Vision API
- Google Cloud Vision
- Custom ML ะผะพะดะตะปะธ

---

### 5. **States** - FSM ัะพััะพัะฝะธั

```
states/
โโโ user_states.py
```

**ะกะพััะพัะฝะธั:**
```python
class UserStates:
    main_menu                  # ะะปะฐะฒะฝะพะต ะผะตะฝั
    waiting_for_recipe_query   # ะะถะธะดะฐะฝะธะต ะทะฐะฟัะพัะฐ ัะตัะตะฟัะฐ
    waiting_for_food_text      # ะะถะธะดะฐะฝะธะต ัะตะบััะฐ ะฑะปัะดะฐ
    waiting_for_food_photo     # ะะถะธะดะฐะฝะธะต ัะพัะพ ะฑะปัะดะฐ
```

**FSM Flow:**
```
START โ main_menu
  โโ waiting_for_recipe_query โ main_menu
  โโ calorie_choice
      โโ waiting_for_food_text โ main_menu
      โโ waiting_for_food_photo โ waiting_for_food_text โ main_menu
```

---

### 6. **Keyboards** - ะะฝัะตััะตะนั

```
keyboards/
โโโ main_keyboard.py
```

**ะะปะฐะฒะธะฐัััั:**

1. **Main Keyboard** - ะะปะฐะฒะฝะพะต ะผะตะฝั
   - ๐ณ ะะฐะนัะธ ัะตัะตะฟั
   - ๐ ะะพะดััะธัะฐัั ะบะฐะปะพัะธะธ
   - โน๏ธ ะะพะผะพัั

2. **Calorie Input Keyboard** - ะัะฑะพั ะฒะฒะพะดะฐ
   - โ๏ธ ะะฒะตััะธ ัะตะบััะพะผ
   - ๐ธ ะัะฟัะฐะฒะธัั ัะพัะพ
   - โ๏ธ ะะฐะทะฐะด

3. **Back Keyboard** - ะะฐะฒะธะณะฐัะธั
   - โ๏ธ ะะฐะทะฐะด

---

### 7. **Utils** - ะัะฟะพะผะพะณะฐัะตะปัะฝัะต ััะฝะบัะธะธ

```
utils/
โโโ helpers.py
```

**ะคัะฝะบัะธะธ:**
- `format_recipe(recipe: dict)` - ะคะพัะผะฐัะธัะพะฒะฐะฝะธะต ัะตัะตะฟัะฐ ะดะปั ะพัะพะฑัะฐะถะตะฝะธั
- `format_nutrition_info(items: list)` - ะคะพัะผะฐัะธัะพะฒะฐะฝะธะต ะดะฐะฝะฝัั ะพ ะบะฐะปะพัะธัั

---

## ๐ ะะพัะพะบ ะดะฐะฝะฝัั

### ะะพะธัะบ ัะตัะตะฟัะพะฒ:
```
User Input โ Recipe Handler โ Recipe Service โ API Ninjas
                โ                                    โ
           Format & Send โ โ โ โ โ โ โ โ โ โ Response
```

### ะะพะดััะตั ะบะฐะปะพัะธะน:
```
User Input (Text/Photo)
    โ
Calories Handler
    โ
Image Analyzer (ะตัะปะธ ัะพัะพ) โ Request text description
    โ
Calorie Service โ API Ninjas
    โ
Format & Calculate totals
    โ
Send to User
```

---

## ๐ง ะขะตัะฝะพะปะพะณะธัะตัะบะธะน ััะตะบ

| ะะพะผะฟะพะฝะตะฝั | ะขะตัะฝะพะปะพะณะธั | ะะฐะทะฝะฐัะตะฝะธะต |
|-----------|------------|------------|
| Framework | aiogram 3.13 | Telegram Bot API |
| HTTP Client | aiohttp | ะัะธะฝััะพะฝะฝัะต ะทะฐะฟัะพัั |
| State Management | FSM (aiogram) | ะฃะฟัะฐะฒะปะตะฝะธะต ัะพััะพัะฝะธัะผะธ |
| Image Processing | Pillow | ะะฑัะฐะฑะพัะบะฐ ะธะทะพะฑัะฐะถะตะฝะธะน |
| API Provider | CalorieNinjas | ะะตัะตะฟัั ะธ ะบะฐะปะพัะธะธ |
| Storage | MemoryStorage | FSM ััะฐะฝะธะปะธัะต |

---

## ๐ ะะธะฐะณัะฐะผะผะฐ ะฐััะธัะตะบัััั

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                   TELEGRAM BOT                       โ
โ                     (main.py)                        โ
โโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                     โ
         โโโโโโโโโโโโโดโโโโโโโโโโโโ
         โ                       โ
         โผ                       โผ
โโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโ
โ    HANDLERS     โ    โ     STATES      โ
โ  - start.py     โโโโโโค  - FSM Logic    โ
โ  - recipes.py   โ    โโโโโโโโโโโโโโโโโโโ
โ  - calories.py  โ
โโโโโโโโโโฌโโโโโโโโโ
         โ
         โผ
โโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโ
โ    SERVICES     โโโโโบโ   EXTERNAL API  โ
โ  - recipe_api   โ    โ - CalorieNinjas โ
โ  - calorie_api  โ    โ - Recipe API    โ
โ  - image_analyzerโ   โโโโโโโโโโโโโโโโโโโ
โโโโโโโโโโฌโโโโโโโโโ
         โ
         โผ
โโโโโโโโโโโโโโโโโโโ
โ      UTILS      โ
โ  - helpers.py   โ
โ  - formatters   โ
โโโโโโโโโโโโโโโโโโโ
         โ
         โผ
โโโโโโโโโโโโโโโโโโโ
โ    KEYBOARDS    โ
โ  - UI Elements  โ
โโโโโโโโโโโโโโโโโโโ
```

---

## ๐ ะะฐััะธััะตะผะพััั

### ะะตะณะบะพ ะดะพะฑะฐะฒะธัั:

1. **ะะพะฒัะต ะบะพะผะฐะฝะดั**
   - ะกะพะทะดะฐัั ะฝะพะฒัะน handler ะฒ `handlers/`
   - ะะพะฑะฐะฒะธัั ัะพััะตั ะฒ `main.py`

2. **ะะพะฒัะต API**
   - ะกะพะทะดะฐัั service ะฒ `services/`
   - ะะพะฑะฐะฒะธัั ะฝะฐัััะพะนะบะธ ะฒ `config/`

3. **ะะพะฒัะต ัะพััะพัะฝะธั**
   - ะะฐััะธัะธัั `UserStates` ะฒ `states/`
   - ะะฑะฝะพะฒะธัั ะพะฑัะฐะฑะพััะธะบะธ

4. **ะะฐะทั ะดะฐะฝะฝัั**
   - ะะพะฑะฐะฒะธัั ะผะพะดัะปั `database/`
   - ะะฐะผะตะฝะธัั MemoryStorage ะฝะฐ Redis/SQL

5. **AI ะผะพะดะตะปั ะดะปั ัะพัะพ**
   - ะะฑะฝะพะฒะธัั `ImageAnalyzer`
   - ะะพะฑะฐะฒะธัั API ะบะปััะธ ะฒ config

---

## ๐ ะะตะทะพะฟะฐัะฝะพััั

- API ะบะปััะธ ััะฐะฝัััั ะฒ `.env` ัะฐะนะปะต (ะฝะต ะฟะพะฟะฐะดะฐัั ะฒ git)
- `config/settings.py` ะทะฐะณััะถะฐะตั ะบะปััะธ ะธะท ะฟะตัะตะผะตะฝะฝัั ะพะบััะถะตะฝะธั
- ะัะตะผะตะฝะฝัะต ัะฐะนะปั ัะดะฐะปััััั ะฟะพัะปะต ะพะฑัะฐะฑะพัะบะธ
- `.gitignore` ะธัะบะปััะฐะตั ััะฒััะฒะธัะตะปัะฝัะต ะดะฐะฝะฝัะต (`.env`, ะบัั, ะปะพะณะธ)
- ะะฐะปะธะดะฐัะธั ะฟะพะปัะทะพะฒะฐัะตะปััะบะพะณะพ ะฒะฒะพะดะฐ

---

## ๐ ะัะพะธะทะฒะพะดะธัะตะปัะฝะพััั

- **ะัะธะฝััะพะฝะฝะพััั**: ะัะต ะพะฟะตัะฐัะธะธ I/O ะฐัะธะฝััะพะฝะฝัะต
- **ะััะธัะพะฒะฐะฝะธะต**: ะะพะบะฐะปัะฝะพะต ะบััะธัะพะฒะฐะฝะธะต ะธะทะพะฑัะฐะถะตะฝะธะน
- **Timeout**: 10 ัะตะบัะฝะด ะดะปั API ะทะฐะฟัะพัะพะฒ
- **ะัะปะธะฝะณ**: ะญััะตะบัะธะฒะฝัะน long polling

---

## ๐งช ะขะตััะธัะพะฒะฐะฝะธะต (ัะตะบะพะผะตะฝะดะฐัะธะธ)

ะะปั production ัะตะบะพะผะตะฝะดัะตััั ะดะพะฑะฐะฒะธัั:

```
tests/
โโโ test_handlers/
โ   โโโ test_start.py
โ   โโโ test_recipes.py
โ   โโโ test_calories.py
โโโ test_services/
โ   โโโ test_recipe_api.py
โ   โโโ test_calorie_api.py
โโโ conftest.py
```

---

## ๐ ะะฐััะตัะฝั ะฟัะพะตะบัะธัะพะฒะฐะฝะธั

1. **Router Pattern** - ะะฐะทะดะตะปะตะฝะธะต ะพะฑัะฐะฑะพััะธะบะพะฒ ะฟะพ ััะฝะบัะธะพะฝะฐะปั
2. **Service Layer** - ะะทะพะปััะธั ะฑะธะทะฝะตั-ะปะพะณะธะบะธ
3. **State Machine** - FSM ะดะปั ัะฟัะฐะฒะปะตะฝะธั ะดะธะฐะปะพะณะฐะผะธ
4. **Dependency Injection** - ะะตัะตะดะฐัะฐ ัะตัะฒะธัะพะฒ ัะตัะตะท ะฟะฐัะฐะผะตััั
5. **Single Responsibility** - ะะฐะถะดัะน ะผะพะดัะปั ะพัะฒะตัะฐะตั ะทะฐ ะพะดะฝั ะทะฐะดะฐัั

---

## ๐ ะะธะทะฝะตะฝะฝัะน ัะธะบะป ะทะฐะฟัะพัะฐ

```
1. User Message/Command
   โ
2. Telegram sends Update
   โ
3. Dispatcher routes to Handler
   โ
4. Handler checks FSM State
   โ
5. Handler processes message
   โ
6. Service performs business logic
   โ
7. External API call (if needed)
   โ
8. Utils format response
   โ
9. Handler sends reply with Keyboard
   โ
10. FSM State updated
```

---

## ๐ก ะัะตะธะผััะตััะฒะฐ ะฐััะธัะตะบัััั

โ **ะะพะดัะปัะฝะพััั** - ะะตะณะบะพ ะดะพะฑะฐะฒะปััั ะฝะพะฒัะน ััะฝะบัะธะพะฝะฐะป
โ **ะขะตััะธััะตะผะพััั** - ะะฐะถะดัะน ะบะพะผะฟะพะฝะตะฝั ะผะพะถะฝะพ ัะตััะธัะพะฒะฐัั ะพัะดะตะปัะฝะพ
โ **ะะฐัััะฐะฑะธััะตะผะพััั** - ะัะพััะพะต ะดะพะฑะฐะฒะปะตะฝะธะต ะฝะพะฒัั API ะธ ััะฝะบัะธะน
โ **ะงะธัะฐะตะผะพััั** - ะะพะฝััะฝะฐั ััััะบัััะฐ ะฟัะพะตะบัะฐ
โ **ะะพะดะดะตัะถะธะฒะฐะตะผะพััั** - ะะตะณะบะพ ะฝะฐัะพะดะธัั ะธ ะธัะฟัะฐะฒะปััั ะฑะฐะณะธ
โ **Async** - ะััะพะบะฐั ะฟัะพะธะทะฒะพะดะธัะตะปัะฝะพััั

---

## ๐ฏ ะะตะบะพะผะตะฝะดะฐัะธะธ ะฟะพ ัะฐะทะฒะธัะธั

1. **ะะฐะทะฐ ะดะฐะฝะฝัั**
   - ะะพะฑะฐะฒะธัั PostgreSQL/MongoDB
   - ะฅัะฐะฝะธัั ะธััะพัะธั ะทะฐะฟัะพัะพะฒ
   - ะกะพััะฐะฝััั ะฟัะตะดะฟะพััะตะฝะธั ะฟะพะปัะทะพะฒะฐัะตะปะตะน

2. **AI Integration**
   - OpenAI GPT ะดะปั ัะปัััะตะฝะธั ัะตัะตะฟัะพะฒ
   - Vision API ะดะปั ัะฐัะฟะพะทะฝะฐะฒะฐะฝะธั ะตะดั
   - ะะตััะพะฝะฐะปัะฝัะต ัะตะบะพะผะตะฝะดะฐัะธะธ

3. **ะััะธัะพะฒะฐะฝะธะต**
   - Redis ะดะปั ััะฐะฝะตะฝะธั ัะตััะธะน
   - ะััะธัะพะฒะฐะฝะธะต ะฟะพะฟัะปััะฝัั ัะตัะตะฟัะพะฒ
   - Rate limiting

4. **ะะพะฝะธัะพัะธะฝะณ**
   - ะะพะณะธัะพะฒะฐะฝะธะต ะฒ Elasticsearch
   - ะะตััะธะบะธ ะฒ Prometheus
   - ะะปะตััั ะฒ Telegram

5. **ะขะตััะธัะพะฒะฐะฝะธะต**
   - Unit ัะตััั ะดะปั ัะตัะฒะธัะพะฒ
   - Integration ัะตััั ะดะปั handlers
   - E2E ัะตััั ัะตัะตะท aiogram testing

---

ะญัะฐ ะฐััะธัะตะบัััะฐ ะพะฑะตัะฟะตัะธะฒะฐะตั ะฝะฐะดะตะถะฝัั ะพัะฝะพะฒั ะดะปั ัะพััะฐ ะธ ัะฐะทะฒะธัะธั ะฑะพัะฐ! ๐

